#!/bin/sh

# wrtntp - OpenWRT NTP Time Synchronization
# Hexagonal Architecture Implementation v1.0.0

VERSION="1.0.0"
CONFIG_FILE="/etc/wrtntp/wrtntp.conf"
LOG_FILE="/var/log/wrtntp.log"

# Hexagonal Ports Configuration
NTP_PORTS="pool.ntp.org time.google.com ntp.ubuntu.com"
HTTP_PORTS="https://worldtimeapi.org/api/ip https://timeapi.io/api/Time/current/zone?timeZone=UTC"

# Core Business Logic
init_system() {
    load_configuration
    detect_adapters
}

load_configuration() {
    if [ -f "$CONFIG_FILE" ]; then
        . "$CONFIG_FILE"
    else
        # Default configuration
        SYNC_ON_BOOT=true
        BOOT_DELAY=30
        SYNC_INTERVAL=3600
        MAX_RETRIES=3
        NTP_SERVERS="pool.ntp.org time.google.com ntp.ubuntu.com"
    fi
}

save_configuration() {
    mkdir -p "/etc/wrtntp"
    cat > "$CONFIG_FILE" << CONFIG
# wrtntp Configuration
SYNC_ON_BOOT=$SYNC_ON_BOOT
BOOT_DELAY=$BOOT_DELAY
SYNC_INTERVAL=$SYNC_INTERVAL
MAX_RETRIES=$MAX_RETRIES
NTP_SERVERS="$NTP_SERVERS"
CONFIG
}

# Ports Detection
detect_adapters() {
    AVAILABLE_ADAPTERS=""
    
    # NTP adapter detection
    if command -v ntpclient >/dev/null 2>&1 || command -v rdate >/dev/null 2>&1; then
        AVAILABLE_ADAPTERS="$AVAILABLE_ADAPTERS ntp"
    fi
    
    # HTTP adapter detection  
    if command -v wget >/dev/null 2>&1 || command -v curl >/dev/null 2>&1; then
        if check_network_connectivity; then
            AVAILABLE_ADAPTERS="$AVAILABLE_ADAPTERS http"
        fi
    fi
    
    # Android adapter detection
    if command -v adb >/dev/null 2>&1; then
        AVAILABLE_ADAPTERS="$AVAILABLE_ADAPTERS android"
    fi
    
    # RTC adapter detection
    if [ -e /dev/rtc ] || [ -e /dev/rtc0 ] && command -v hwclock >/dev/null 2>&1; then
        AVAILABLE_ADAPTERS="$AVAILABLE_ADAPTERS rtc"
    fi
    
    # Fallback always available
    AVAILABLE_ADAPTERS="$AVAILABLE_ADAPTERS fallback"
}

check_network_connectivity() {
    if ping -c 1 -W 3 8.8.8.8 >/dev/null 2>&1; then
        return 0
    elif command -v wget >/dev/null 2>&1 && wget -q --spider https://google.com >/dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Adapters Implementation
adapter_ntp() {
    echo "Initializing NTP adapter..."
    
    for server in $NTP_PORTS; do
        echo "Trying NTP server: $server"
        if ntpclient -s -h "$server" -i 3 >/dev/null 2>&1; then
            echo "NTP synchronization successful: $server"
            return 0
        fi
    done
    
    # Fallback to rdate
    if command -v rdate >/dev/null 2>&1; then
        echo "Trying rdate fallback..."
        if rdate -s time.nist.gov >/dev/null 2>&1; then
            echo "NTP synchronization successful: rdate"
            return 0
        fi
    fi
    
    echo "NTP adapter failed"
    return 1
}

adapter_http() {
    echo "Initializing HTTP adapter..."
    
    for endpoint in $HTTP_PORTS; do
        echo "Trying HTTP endpoint: $endpoint"
        if command -v wget >/dev/null 2>&1; then
            response=$(wget -q -O - "$endpoint" 2>/dev/null)
        elif command -v curl >/dev/null 2>&1; then
            response=$(curl -s -L "$endpoint" 2>/dev/null)
        else
            continue
        fi
        
        if timestamp=$(echo "$response" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}'); then
            year=$(echo "$timestamp" | cut -d'-' -f1)
            month=$(echo "$timestamp" | cut -d'-' -f2)
            day=$(echo "$timestamp" | cut -d'T' -f1 | cut -d'-' -f3)
            time=$(echo "$timestamp" | cut -d'T' -f2)
            
            if date -s "${year}-${month}-${day} ${time}" >/dev/null 2>&1; then
                echo "HTTP synchronization successful: $endpoint"
                return 0
            fi
        fi
    done
    
    echo "HTTP adapter failed"
    return 1
}

adapter_android() {
    echo "Initializing Android adapter..."
    
    if android_time=$(adb shell 'date "+%Y.%m.%d-%H:%M:%S"' 2>/dev/null); then
        if date -s "$android_time" >/dev/null 2>&1; then
            echo "Android synchronization successful"
            return 0
        fi
    fi
    
    echo "Android adapter failed"
    return 1
}

adapter_rtc() {
    echo "Initializing RTC adapter..."
    
    if hwclock -s; then
        echo "RTC synchronization successful"
        return 0
    fi
    
    echo "RTC adapter failed"
    return 1
}

adapter_fallback() {
    echo "Initializing Fallback adapter..."
    
    # Set to safe date and adjust based on uptime
    date -s "2024-01-01 00:00:00" >/dev/null 2>&1
    
    if [ -e /proc/uptime ]; then
        uptime_seconds=$(cat /proc/uptime | cut -d' ' -f1 | cut -d'.' -f1)
        current_time=$(date +%s)
        boot_time=$((current_time - uptime_seconds))
        
        if date -s "@$boot_time" >/dev/null 2>&1; then
            echo "Fallback synchronization completed"
            return 0
        fi
    fi
    
    echo "Fallback synchronization completed"
    return 0
}

# Core Use Cases
use_case_synchronize_time() {
    echo "Executing time synchronization use case..."
    
    for adapter in ntp http android rtc fallback; do
        if echo "$AVAILABLE_ADAPTERS" | grep -q "$adapter"; then
            echo "Trying $adapter adapter..."
            if "adapter_$adapter"; then
                echo "Synchronization successful via $adapter adapter"
                return 0
            fi
        fi
    done
    
    echo "All synchronization adapters failed"
    return 1
}

use_case_install_dependencies() {
    echo "Checking and installing dependencies..."
    
    if ! command -v ntpclient >/dev/null 2>&1 && ! command -v rdate >/dev/null 2>&1; then
        echo "Installing NTP client..."
        opkg update && opkg install ntpclient
    fi
    
    if ! command -v wget >/dev/null 2>&1 && ! command -v curl >/dev/null 2>&1; then
        echo "Installing HTTP client..."
        opkg update && opkg install wget
    fi
    
    detect_adapters
}

# Update functionality
use_case_update_self() {
    echo "Checking for updates..."
    
    if ! check_network_connectivity; then
        echo "No network connectivity, cannot check for updates"
        return 1
    fi
    
    # Download latest version
    if command -v wget >/dev/null 2>&1; then
        wget -q "https://raw.githubusercontent.com/InetByOu/wrtntp/main/wrtntp" -O "/tmp/wrtntp.new"
    elif command -v curl >/dev/null 2>&1; then
        curl -s -L "https://raw.githubusercontent.com/InetByOu/wrtntp/main/wrtntp" -o "/tmp/wrtntp.new"
    else
        echo "No HTTP client available for update"
        return 1
    fi
    
    if [ ! -s "/tmp/wrtntp.new" ]; then
        echo "Failed to download update"
        return 1
    fi
    
    # Compare versions (simple check)
    current_size=$(stat -c%s "$0" 2>/dev/null || wc -c < "$0")
    new_size=$(stat -c%s "/tmp/wrtntp.new" 2>/dev/null || wc -c < "/tmp/wrtntp.new")
    
    if [ "$current_size" -eq "$new_size" ]; then
        echo "Already up to date"
        rm -f "/tmp/wrtntp.new"
        return 0
    fi
    
    # Backup current version
    cp "$0" "$0.backup"
    
    # Install new version
    if cp "/tmp/wrtntp.new" "$0" && chmod +x "$0"; then
        echo "Successfully updated to latest version"
        rm -f "/tmp/wrtntp.new"
        return 0
    else
        # Restore backup if update failed
        cp "$0.backup" "$0"
        echo "Update failed, restored backup"
        return 1
    fi
}

# Service Modes
service_mode() {
    echo "Starting wrtntp service mode..."
    
    local wait_count=0
    while [ $wait_count -lt 30 ]; do
        if check_network_connectivity; then
            break
        fi
        sleep 5
        wait_count=$((wait_count + 1))
    done
    
    init_system
    if [ "$SYNC_ON_BOOT" = "true" ]; then
        use_case_synchronize_time
    fi
}

boot_mode() {
    echo "Starting wrtntp boot mode..."
    sleep "$BOOT_DELAY"
    service_mode
}

cron_mode() {
    echo "Starting wrtntp cron mode..."
    init_system
    use_case_synchronize_time
}

# User Interface
show_main_menu() {
    while true; do
        clear
        echo "================================================"
        echo "               wrtntp v$VERSION"
        echo "           Hexagonal Time Sync"
        echo "================================================"
        echo
        
        echo "System Status:"
        echo "  Current Time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "  Uptime: $(uptime | cut -d',' -f1 | cut -d' ' -f4-)"
        echo "  Network: $(check_network_connectivity && echo "connected" || echo "disconnected")"
        echo
        
        init_system
        echo "Available Adapters: $AVAILABLE_ADAPTERS"
        echo
        
        echo "Core Operations:"
        echo "  1. Synchronize Time"
        echo "  2. Install Dependencies"
        echo "  3. Check for Updates"
        echo "  4. Service Management"
        echo "  5. Configuration"
        echo "  6. View Logs"
        echo "  7. Exit"
        echo
        
        read -p "Select operation: " choice
        
        case $choice in
            1) use_case_synchronize_time ;;
            2) use_case_install_dependencies ;;
            3) use_case_update_self ;;
            4) show_service_menu ;;
            5) show_config_menu ;;
            6) show_logs ;;
            7) exit 0 ;;
            *) echo "Invalid selection" ;;
        esac
        
        echo
        read -p "Press Enter to continue..." dummy
    done
}

show_service_menu() {
    while true; do
        clear
        echo "Service Management"
        echo "=================="
        echo
        
        echo "Service Operations:"
        echo "  1. Start Service"
        echo "  2. Stop Service"
        echo "  3. Enable Boot Sync"
        echo "  4. Disable Boot Sync"
        echo "  5. Configure Scheduled Sync"
        echo "  6. Back to Main Menu"
        echo
        
        read -p "Select operation: " choice
        
        case $choice in
            1) 
                echo "Starting service..."
                /etc/init.d/wrtntp start 2>/dev/null || echo "Service not available"
                ;;
            2) 
                echo "Stopping service..."
                /etc/init.d/wrtntp stop 2>/dev/null || echo "Service not available"
                ;;
            3) 
                SYNC_ON_BOOT=true
                save_configuration
                echo "Boot sync enabled"
                ;;
            4) 
                SYNC_ON_BOOT=false
                save_configuration
                echo "Boot sync disabled"
                ;;
            5) 
                configure_scheduled_sync
                ;;
            6) 
                return 
                ;;
            *) 
                echo "Invalid selection" 
                ;;
        esac
        
        echo
        read -p "Press Enter to continue..." dummy
    done
}

show_config_menu() {
    while true; do
        clear
        echo "Configuration"
        echo "============="
        echo
        
        echo "Current Configuration:"
        echo "  Sync on Boot: $SYNC_ON_BOOT"
        echo "  Boot Delay: ${BOOT_DELAY}s"
        echo "  Sync Interval: $SYNC_INTERVAL seconds"
        echo "  Max Retries: $MAX_RETRIES"
        echo
        
        echo "Configuration Operations:"
        echo "  1. Toggle Sync on Boot"
        echo "  2. Set Boot Delay"
        echo "  3. Set Sync Interval"
        echo "  4. Set Max Retries"
        echo "  5. Save Configuration"
        echo "  6. Back to Main Menu"
        echo
        
        read -p "Select operation: " choice
        
        case $choice in
            1)
                SYNC_ON_BOOT=$([ "$SYNC_ON_BOOT" = "true" ] && echo "false" || echo "true")
                ;;
            2)
                read -p "Enter boot delay (seconds): " delay
                if [ -n "$delay" ] && [ "$delay" -eq "$delay" ] 2>/dev/null; then
                    BOOT_DELAY="$delay"
                fi
                ;;
            3)
                read -p "Enter sync interval (seconds): " interval
                if [ -n "$interval" ] && [ "$interval" -eq "$interval" ] 2>/dev/null; then
                    SYNC_INTERVAL="$interval"
                fi
                ;;
            4)
                read -p "Enter max retries: " retries
                if [ -n "$retries" ] && [ "$retries" -eq "$retries" ] 2>/dev/null; then
                    MAX_RETRIES="$retries"
                fi
                ;;
            5)
                save_configuration
                echo "Configuration saved"
                ;;
            6)
                return
                ;;
            *)
                echo "Invalid selection"
                ;;
        esac
        
        echo
        read -p "Press Enter to continue..." dummy
    done
}

configure_scheduled_sync() {
    clear
    echo "Scheduled Sync Configuration"
    echo "============================"
    echo
    
    echo "Sync Intervals:"
    echo "  1. Every 15 minutes"
    echo "  2. Every 30 minutes"
    echo "  3. Every hour"
    echo "  4. Every 2 hours"
    echo "  5. Every 6 hours"
    echo "  6. Every 12 hours"
    echo "  7. Every 24 hours"
    echo "  8. Disable Scheduled Sync"
    echo "  9. Back to Service Menu"
    echo
    
    read -p "Select interval: " choice
    
    case $choice in
        1) interval=900 ;;
        2) interval=1800 ;;
        3) interval=3600 ;;
        4) interval=7200 ;;
        5) interval=21600 ;;
        6) interval=43200 ;;
        7) interval=86400 ;;
        8)
            crontab -l 2>/dev/null | grep -v "wrtntp" | crontab -
            echo "Scheduled sync disabled"
            return
            ;;
        9) return ;;
        *) echo "Invalid selection"; return ;;
    esac
    
    SYNC_INTERVAL=$interval
    save_configuration
    
    # Install cron job
    case $interval in
        900) schedule="*/15 * * * *" ;;
        1800) schedule="*/30 * * * *" ;;
        3600) schedule="0 * * * *" ;;
        7200) schedule="0 */2 * * *" ;;
        21600) schedule="0 */6 * * *" ;;
        43200) schedule="0 */12 * * *" ;;
        86400) schedule="0 0 * * *" ;;
    esac
    
    crontab -l 2>/dev/null | grep -v "wrtntp" | crontab -
    (crontab -l 2>/dev/null; echo "$schedule /usr/bin/wrtntp --cron >> $LOG_FILE 2>&1") | crontab -
    /etc/init.d/cron restart >/dev/null 2>&1
    
    echo "Scheduled sync configured: $schedule"
}

show_logs() {
    clear
    echo "System Logs"
    echo "==========="
    echo
    
    if [ -f "$LOG_FILE" ] && [ -s "$LOG_FILE" ]; then
        tail -20 "$LOG_FILE"
    else
        echo "No logs available"
    fi
    
    echo
    read -p "Press Enter to return..." dummy
}

show_help() {
    echo "wrtntp - OpenWRT NTP Time Synchronization v$VERSION"
    echo
    echo "Usage: wrtntp [COMMAND]"
    echo
    echo "Commands:"
    echo "  --sync       Synchronize time immediately"
    echo "  --service    Run in service mode"
    echo "  --boot       Run boot synchronization"
    echo "  --cron       Run scheduled synchronization"
    echo "  --update     Check and install updates"
    echo "  --status     Show synchronization status"
    echo "  --help       Show this help message"
    echo
    echo "Examples:"
    echo "  wrtntp --sync           # Sync time now"
    echo "  wrtntp --status         # Show sync status"
    echo "  wrtntp --update         # Update to latest version"
    echo "  wrtntp                  # Interactive mode"
}

# Main function
main() {
    case "${1:-}" in
        --sync)
            init_system
            use_case_synchronize_time
            ;;
        --service)
            service_mode
            ;;
        --boot)
            boot_mode
            ;;
        --cron)
            cron_mode
            ;;
        --update)
            use_case_update_self
            ;;
        --status)
            echo "Current time: $(date)"
            echo "System uptime: $(uptime)"
            init_system
            echo "Available adapters: $AVAILABLE_ADAPTERS"
            ;;
        --help|-h)
            show_help
            ;;
        *)
            if [ -t 0 ]; then
                show_main_menu
            else
                show_help
            fi
            ;;
    esac
}

# Run main if script is executed directly
main "$@"
